name: deploy-docs

on:
  push:
    branches:
      - dev
      - staging
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build docs
        run: npm run build

      - name: Health check bundle
        run: |
          python -m http.server 3000 --directory build &
          sleep 5
          curl -f http://localhost:3000/health.json
          curl -f http://localhost:3000/version.json

      - name: Select environment
        id: env
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "environment=prod" >> "$GITHUB_OUTPUT"
          elif [[ "${GITHUB_REF_NAME}" == "staging" ]]; then
            echo "environment=staging" >> "$GITHUB_OUTPUT"
          else
            echo "environment=dev" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to Railway
        if: ${{ secrets.RAILWAY_TOKEN != '' }}
        uses: railwayapp/railway-action@v2
        with:
          service: docs-site
          command: railway up --environment ${{ steps.env.outputs.environment }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Upload artifact (GH Pages fallback)
        if: ${{ secrets.RAILWAY_TOKEN == '' }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: build
